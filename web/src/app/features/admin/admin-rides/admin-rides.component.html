<div class="main-container">
  <div class="page-header">
    <h1 class="page-title">Rides Management</h1>
    <span class="rides-count" *ngIf="activeTab === 'history' && totalElements > 0">{{ totalElements }} rides found</span>
    <span class="rides-count" *ngIf="activeTab === 'active' && displayedRides.length > 0">{{ displayedRides.length }} active rides</span>
  </div>

  <div class="tabs">
    <button class="tab-btn" [class.active]="activeTab === 'active'" (click)="switchTab('active')">Active Rides</button>
    <button class="tab-btn" [class.active]="activeTab === 'history'" (click)="switchTab('history')">Ride History</button>
  </div>

  <div class="card filter-section" *ngIf="activeTab === 'history'">
    <div class="filter-row">
      <div class="filter-group">
        <label>From</label>
        <input type="date" [(ngModel)]="startDate">
      </div>
      <div class="filter-group">
        <label>To</label>
        <input type="date" [(ngModel)]="endDate">
      </div>
      <button class="filter-btn" (click)="applyFilter()" [disabled]="loading || !isFilterValid()">Filter</button>
      <button class="filter-btn reset-btn" (click)="resetFilter()" [disabled]="loading">Reset</button>
    </div>
    <p class="error" *ngIf="!isFilterValid()" style="margin-top: 12px; margin-bottom: 0;">Start date cannot be greater than end date</p>
  </div>

  <div class="card filter-section" *ngIf="activeTab === 'active'">
    <div class="filter-row">
      <div class="filter-group full-width">
        <label>Search Driver</label>
        <input type="text" [(ngModel)]="driverSearch" (ngModelChange)="applyFilterAndSort()" placeholder="Search by name or email...">
      </div>
      <button class="filter-btn" (click)="loadActiveRides()" [disabled]="loading">Refresh</button>
    </div>
  </div>

  <p class="error" *ngIf="error && (activeTab === 'active' || isFilterValid())">{{ error }}</p>

  <div class="loading" *ngIf="loading">Loading rides...</div>

  <div class="rides-table-container" *ngIf="!loading && displayedRides.length > 0">
    <table class="rides-table">
      <thead>
        <tr>
          <th class="sortable" (click)="sortBy('createdAt')">
            Created {{ getSortIcon('createdAt') }}
          </th>
          <th class="sortable" (click)="sortBy('startedAt')">
            Start {{ getSortIcon('startedAt') }}
          </th>
          <th class="sortable" (click)="sortBy('completedAt')">
            End {{ getSortIcon('completedAt') }}
          </th>
          <th class="sortable" (click)="sortBy('pickupAddress')">
            Pickup {{ getSortIcon('pickupAddress') }}
          </th>
          <th class="sortable" (click)="sortBy('dropoffAddress')">
            Destination {{ getSortIcon('dropoffAddress') }}
          </th>
          <th class="sortable" (click)="sortBy('status')">
            Status {{ getSortIcon('status') }}
          </th>
          <th class="sortable" (click)="sortBy('price')">
            Price {{ getSortIcon('price') }}
          </th>
          <th class="sortable" (click)="sortBy('distanceKm')">
            Distance {{ getSortIcon('distanceKm') }}
          </th>
          <th>Driver</th>
          <th>Passengers</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ride of displayedRides" (click)="onRideClick(ride)" class="ride-row">
          <td>
            <div class="date-cell">
              <span class="date">{{ formatDate(ride.createdAt) }}</span>
              <span class="time">{{ formatTime(ride.createdAt) }}</span>
            </div>
          </td>
          <td>
            <div class="date-cell">
              <span class="date">{{ formatDate(ride.startedAt) }}</span>
              <span class="time">{{ formatTime(ride.startedAt) }}</span>
            </div>
          </td>
          <td>
            <div class="date-cell">
              <span class="date">{{ formatDate(ride.completedAt) }}</span>
              <span class="time">{{ formatTime(ride.completedAt) }}</span>
            </div>
          </td>
          <td class="address-cell" [title]="ride.pickupAddress">{{ ride.pickupAddress }}</td>
          <td class="address-cell" [title]="ride.dropoffAddress">{{ ride.dropoffAddress }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(ride)">
              <span *ngIf="ride.panicActivated" class="panic-icon">‚ö†Ô∏è</span>
              {{ getStatusLabel(ride) }}
            </span>
          </td>
          <td class="price-cell">{{ formatPrice(ride.price) }}</td>
          <td>{{ formatDistance(ride.distanceKm) }}</td>
          <td class="driver-cell" [title]="ride.driver?.email || ''">{{ getDriverName(ride) }}</td>
          <td class="passengers-cell" [title]="getPassengerNames(ride)">
            {{ ride.passengers.length || 0 }} passenger{{ ride.passengers.length !== 1 ? 's' : '' }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="empty-state" *ngIf="!loading && displayedRides.length === 0 && !error">
    <div class="empty-icon">üöó</div>
    <div class="empty-title">No rides found</div>
    <div class="empty-text" *ngIf="activeTab === 'history'">Try adjusting your date filter</div>
    <div class="empty-text" *ngIf="activeTab === 'active'">There are no currently active rides matching your search</div>
  </div>

  <div class="pagination" *ngIf="activeTab === 'history' && totalPages > 1">
    <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 0">
      ‚Üê Previous
    </button>
    <span class="page-info">Page {{ currentPage + 1 }} of {{ totalPages }}</span>
    <button class="page-btn" (click)="nextPage()" [disabled]="currentPage >= totalPages - 1">
      Next ‚Üí
    </button>
  </div>
</div>

<!-- Modal -->
<app-admin-ride-detail-modal
  *ngIf="showModal && selectedRideId"
  [rideId]="selectedRideId"
  (close)="closeModal()"
></app-admin-ride-detail-modal>
