<main class="ride-page">
  <section class="ride-split">
    <aside class="map-panel" aria-label="Map panel">
      <div class="map-container" #mapContainer></div>
    </aside>

    <section class="form-panel" aria-label="Ride request">
      <div class="ride-card">
        <h2 class="ride-title">Request Ride</h2>

        <form [formGroup]="form" class="ride-form">
          <div class="block">
            <div class="block-label">Pickup & destinations</div>

            <div class="field-with-clear">
              <app-address-autocomplete
                #pickupAutocomplete
                placeholder="Pickup location"
                [initialValue]="form.get('pickup.address')?.value || ''"
                (addressSelected)="onPickupSelected($event)"
                (focused)="onPickupFocus()"
              ></app-address-autocomplete>
              <button
                *ngIf="form.get('pickup.address')?.value"
                class="icon-btn"
                type="button"
                (click)="clearPickup()"
              >×</button>
            </div>

            <div class="stops" formArrayName="stops">
              <div class="stop" *ngFor="let stop of stops.controls; let i = index" [formGroupName]="i">
                <app-address-autocomplete
                  #stopAutocomplete
                  placeholder="Stop {{ i + 1 }}"
                  [initialValue]="stop.get('address')?.value || ''"
                  (addressSelected)="onStopSelected(i, $event)"
                  (focused)="onStopFocus(i)"
                ></app-address-autocomplete>
                <button class="icon-btn" type="button" (click)="removeStop(i)">×</button>
              </div>

              <button class="ghost-btn" type="button" (click)="addStop()">Add Stop</button>
            </div>

            <div class="field-with-clear">
              <app-address-autocomplete
                #dropoffAutocomplete
                placeholder="Final destination"
                [initialValue]="form.get('dropoff.address')?.value || ''"
                (addressSelected)="onDropoffSelected($event)"
                (focused)="onDropoffFocus()"
              ></app-address-autocomplete>
              <button
                *ngIf="form.get('dropoff.address')?.value"
                class="icon-btn"
                type="button"
                (click)="clearDropoff()"
              >×</button>
            </div>
          </div>

          <div class="block">
            <div class="block-label">Linked passengers (emails)</div>
            <input
              class="input"
              formControlName="passengerEmails"
              placeholder="Enter emails separated by comma"
              autocomplete="email"
            />
          </div>

          <div class="row-2">
            <div class="block compact">
              <div class="block-label center">Vehicle type</div>
              <div class="segmented" role="group" aria-label="Vehicle type">
                <button
                  type="button"
                  class="seg-btn"
                  [class.active]="form.get('vehicleType')?.value === 'STANDARD'"
                  (click)="setVehicleType('STANDARD')"
                >
                  Standard
                </button>
                <button
                  type="button"
                  class="seg-btn"
                  [class.active]="form.get('vehicleType')?.value === 'VAN'"
                  (click)="setVehicleType('VAN')"
                >
                  Van
                </button>
                <button
                  type="button"
                  class="seg-btn"
                  [class.active]="form.get('vehicleType')?.value === 'LUX'"
                  (click)="setVehicleType('LUX')"
                >
                  Lux
                </button>
              </div>
            </div>

            <div class="block compact">
              <div class="block-label center">Schedule for later</div>
              <input
                class="input"
                type="datetime-local"
                formControlName="scheduledAt"
                [min]="scheduledMin"
                [max]="scheduledMax"
                step="60"
              />
            </div>
          </div>

          <div class="toggles">
            <label class="toggle">
              <input type="checkbox" formControlName="babyTransport" />
              <span>Baby Seat</span>
            </label>
            <label class="toggle">
              <input type="checkbox" formControlName="petTransport" />
              <span>Pet Friendly</span>
            </label>
          </div>

          <button
            class="primary"
            type="button"
            (click)="orderRide()"
          >
            Request Now
          </button>
          <button
            class="secondary"
            type="button"
            (click)="chooseFavoriteRoute()"
          >
            Choose Favorite Route
          </button>

          <button
            class="link"
            type="button"
            (click)="estimateRide()"
          >
            Estimate price
          </button>

          <p class="error" *ngIf="error">{{ error }}</p>

          <div class="result" *ngIf="estimate">
            <div class="result-row">
              <span>Estimated price</span>
              <strong>{{ estimate.estimatedPrice }} RSD</strong>
            </div>
            <div class="result-row">
              <span>Distance</span>
              <strong>{{ estimate.distanceKm }} km</strong>
            </div>
            <div class="result-row">
              <span>Duration</span>
              <strong>{{ estimate.estimatedDurationMinutes }} min</strong>
            </div>
          </div>

          <div class="result" *ngIf="orderResult">
            <div class="result-row">
              <span>Status</span>
              <strong>{{ orderResult.status }}</strong>
            </div>
            <div class="muted">{{ orderResult.message }}</div>
            <div class="muted" *ngIf="orderResult.rideId">Ride ID: {{ orderResult.rideId }}</div>
            <div class="muted" *ngIf="orderResult.assignedDriverEmail">Driver: {{ orderResult.assignedDriverEmail }}</div>
          </div>
        </form>
      </div>
    </section>
  </section>

  <!-- Favorite Routes Modal -->
  <div class="modal-overlay" *ngIf="showFavoriteRoutesModal" (click)="closeFavoriteRoutesModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Choose Favorite Route</h3>
        <button class="icon-btn" type="button" (click)="closeFavoriteRoutesModal()" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <div *ngIf="favoriteRoutes.length === 0" class="empty-state">
          <p>You don't have any favorite routes yet.</p>
          <p class="muted">Complete a ride and add it to favorites from your ride history.</p>
        </div>
        <div class="favorite-routes-list" *ngIf="favoriteRoutes.length > 0">
          <div 
            class="favorite-route-item" 
            *ngFor="let route of favoriteRoutes"
            (click)="selectFavoriteRoute(route)"
          >
            <div class="route-name">{{ route.name || 'Unnamed Route' }}</div>
            <div class="route-details">
              <div class="route-location">
                <span class="location-label">From:</span>
                <span class="location-address">{{ route.pickup.address }}</span>
              </div>
              <div class="route-location" *ngIf="route.stops && route.stops.length > 0">
                <span class="location-label">Stops:</span>
                <span class="location-address">{{ route.stops.length }} stop(s)</span>
              </div>
              <div class="route-location">
                <span class="location-label">To:</span>
                <span class="location-address">{{ route.dropoff.address }}</span>
              </div>
              <div class="route-meta">
                <span class="vehicle-type">{{ route.vehicleType }}</span>
                <span class="badge" *ngIf="route.babyTransport">Baby Seat</span>
                <span class="badge" *ngIf="route.petTransport">Pet Friendly</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
