<main class="ride-page">
  <section class="ride-split">
    <aside class="map-panel" aria-label="Map panel">
      <app-ride-map
        [pickupLocation]="mapPickup"
        [dropoffLocation]="mapDropoff"
        [stops]="mapStops"
        [routePoints]="estimate ? [] : mapRoutePoints"
        [estimatedRoute]="estimate?.routePoints"
        [driverLocation]="driverLocation"
        [locked]="false"
        (mapClick)="onMapClick($event)"
      ></app-ride-map>
    </aside>

    <section class="form-panel" aria-label="Ride request">
      <div class="ride-card">
        <h2 class="ride-title">Request Ride</h2>

        <form [formGroup]="form" class="ride-form">
          <!-- Show form only when no order result exists -->
          <ng-container *ngIf="!orderResult">
            <div class="block">
              <div class="block-label">Pickup & destinations</div>

              <div class="field-with-clear">
                <app-address-autocomplete
                  #pickupAutocomplete
                  placeholder="Pickup location"
                  [initialValue]="form.get('pickup.address')?.value || ''"
                  (addressSelected)="onPickupSelected($event)"
                  (focused)="onPickupFocus()"
                ></app-address-autocomplete>
                <button
                  *ngIf="form.get('pickup.address')?.value"
                  class="icon-btn"
                  type="button"
                  (click)="clearPickup()"
                >Ã—</button>
              </div>

              <div class="stops" formArrayName="stops">
                <div class="stop" *ngFor="let stop of stops.controls; let i = index" [formGroupName]="i">
                  <app-address-autocomplete
                    #stopAutocomplete
                    placeholder="Stop {{ i + 1 }}"
                    [initialValue]="stop.get('address')?.value || ''"
                    (addressSelected)="onStopSelected(i, $event)"
                    (focused)="onStopFocus(i)"
                  ></app-address-autocomplete>
                  <button class="icon-btn" type="button" (click)="removeStop(i)">Ã—</button>
                </div>

                <button class="ghost-btn" type="button" (click)="addStop()">Add Stop</button>
              </div>

              <div class="field-with-clear">
                <app-address-autocomplete
                  #dropoffAutocomplete
                  placeholder="Final destination"
                  [initialValue]="form.get('dropoff.address')?.value || ''"
                  (addressSelected)="onDropoffSelected($event)"
                  (focused)="onDropoffFocus()"
                ></app-address-autocomplete>
                <button
                  *ngIf="form.get('dropoff.address')?.value"
                  class="icon-btn"
                  type="button"
                  (click)="clearDropoff()"
                >Ã—</button>
              </div>
            </div>

            <div class="block">
              <div class="block-label">Linked passengers (emails)</div>
              <input
                class="input"
                formControlName="passengerEmails"
                placeholder="Enter emails separated by comma"
                autocomplete="email"
              />
            </div>

            <div class="row-2">
              <div class="block compact">
                <div class="block-label center">Vehicle type</div>
                <div class="segmented" role="group" aria-label="Vehicle type">
                  <button
                    type="button"
                    class="seg-btn"
                    [class.active]="form.get('vehicleType')?.value === 'STANDARD'"
                    (click)="setVehicleType('STANDARD')"
                  >
                    Standard
                  </button>
                  <button
                    type="button"
                    class="seg-btn"
                    [class.active]="form.get('vehicleType')?.value === 'VAN'"
                    (click)="setVehicleType('VAN')"
                  >
                    Van
                  </button>
                  <button
                    type="button"
                    class="seg-btn"
                    [class.active]="form.get('vehicleType')?.value === 'LUX'"
                    (click)="setVehicleType('LUX')"
                  >
                    Lux
                  </button>
                </div>
              </div>

              <div class="block compact">
                <div class="block-label center">Schedule for later</div>
                <input
                  class="input"
                  type="datetime-local"
                  formControlName="scheduledAt"
                  [min]="scheduledMin"
                  [max]="scheduledMax"
                  step="60"
                />
              </div>
            </div>

            <div class="toggles">
              <label class="toggle">
                <input type="checkbox" formControlName="babyTransport" />
                <span>Baby Seat</span>
              </label>
              <label class="toggle">
                <input type="checkbox" formControlName="petTransport" />
                <span>Pet Friendly</span>
              </label>
            </div>

            <button
              class="primary"
              type="button"
              (click)="orderRide()"
            >
              Request Now
            </button>
            <button
              class="secondary"
              type="button"
              (click)="chooseFavoriteRoute()"
            >
              Choose Favorite Route
            </button>

            <button
              class="link"
              type="button"
              (click)="estimateRide()"
            >
              Estimate price
            </button>
          </ng-container>

          <!-- Single info modal: show either error, estimate, or order result -->
          <p #errorMessage class="error" *ngIf="error && !estimate && !orderResult">{{ error }}</p>

          <div class="info-modal" *ngIf="estimate && !orderResult">
            <div class="modal-title">Price Estimate</div>
            <div class="info-row">
              <span>Estimated price</span>
              <strong>{{ estimate.estimatedPrice }} RSD</strong>
            </div>
            <div class="info-row">
              <span>Distance</span>
              <strong>{{ estimate.distanceKm }} km</strong>
            </div>
            <div class="info-row">
              <span>Duration</span>
              <strong>{{ estimate.estimatedDurationMinutes }} min</strong>
            </div>
          </div>

          <div class="info-modal" *ngIf="orderResult && !error">
            <div class="modal-title">Ride Details</div>
            <div class="info-row">
              <span>Status</span>
              <strong
                [class.status-success]="orderResult.status === 'ACCEPTED' || orderResult.status === 'PENDING'"
                [class.status-cancelled]="orderResult.status === 'CANCELLED'">
                {{ orderResult.status }}
              </strong>
            </div>
            <div class="info-message">{{ orderResult.message }}</div>
            <div class="info-detail" *ngIf="orderResult.rideId">
              <span class="detail-label">Ride ID:</span> {{ orderResult.rideId }}
            </div>
            <div class="info-detail" *ngIf="orderResult.assignedDriverEmail">
              <span class="detail-label">Driver:</span> {{ orderResult.assignedDriverEmail }}
            </div>

            <!-- ETA display when tracking -->
            <div class="info-row eta-row" *ngIf="isRideActive && estimatedTimeMinutes !== undefined">
              <span>Estimated arrival</span>
              <strong class="eta-value">{{ estimatedTimeMinutes }} min</strong>
            </div>

            <!-- Report inconsistency section -->
            <div class="report-section" *ngIf="isRideActive && (rideStatus === 'IN_PROGRESS' || rideStatus === 'STOP_REQUESTED')">
              <button
                class="link report-link"
                type="button"
                (click)="toggleReportForm()"
              >
                {{ showReportForm ? 'Cancel Report' : 'Report Driver Inconsistency' }}
              </button>

              <div class="report-form" *ngIf="showReportForm">
                <textarea
                  class="input report-textarea"
                  [(ngModel)]="reportText"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Describe the issue..."
                  rows="3"
                ></textarea>
                <button
                  class="primary"
                  type="button"
                  [disabled]="reportSubmitting || !reportText.trim()"
                  (click)="submitReport()"
                >
                  {{ reportSubmitting ? 'Submitting...' : 'Submit Report' }}
                </button>
              </div>

              <p class="success-message" *ngIf="reportSuccess">{{ reportSuccess }}</p>
            </div>

            <button
              *ngIf="isRideActive && rideStatus === 'IN_PROGRESS' && !stopRequested"
              class="danger-btn"
              type="button"
              (click)="requestStopRide()"
            >
              Request Stop
            </button>
            <button
              *ngIf="isRideActive && (rideStatus === 'IN_PROGRESS' || rideStatus === 'STOP_REQUESTED')"
              class="panic-btn"
              type="button"
              [disabled]="panicActivated"
              (click)="activatePanic()"
            >
              {{ panicActivated ? 'ðŸš¨ PANIC ACTIVATED' : 'ðŸš¨ PANIC' }}
            </button>
            <button
              *ngIf="isRideActive && rideStatus !== 'IN_PROGRESS' && rideStatus !== 'STOP_REQUESTED' && !stopRequested"
              class="danger-btn"
              type="button"
              (click)="cancelRide()"
            >
              Cancel Ride
            </button>
            <button
              *ngIf="!isRideActive"
              class="secondary"
              type="button"
              (click)="resetForm()"
            >
              Request Another Ride
            </button>
          </div>
        </form>
      </div>
    </section>
  </section>

  <!-- Favorite Routes Modal -->
  <div class="modal-overlay" *ngIf="showFavoriteRoutesModal" (click)="closeFavoriteRoutesModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Choose Favorite Route</h3>
        <button class="icon-btn" type="button" (click)="closeFavoriteRoutesModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="favorite-routes-list" *ngIf="favoriteRoutes.length > 0">
          <div
            class="favorite-route-item"
            *ngFor="let route of favoriteRoutes"
            (click)="selectFavoriteRoute(route)"
          >
            <div class="route-name">{{ route.name || 'Unnamed Route' }}</div>
            <div class="route-details">
              <div class="route-location">
                <span class="location-label">From:</span>
                <span class="location-address">{{ isCoordinates(route.pickup.address) ? '(Invalid address - coordinates only)' : route.pickup.address }}</span>
              </div>
              <div class="route-location" *ngFor="let stop of route.stops; let i = index">
                <span class="location-label">Stop {{ i + 1 }}:</span>
                <span class="location-address">{{ isCoordinates(stop.address) ? '(Invalid address - coordinates only)' : stop.address }}</span>
              </div>
              <div class="route-location">
                <span class="location-label">To:</span>
                <span class="location-address">{{ isCoordinates(route.dropoff.address) ? '(Invalid address - coordinates only)' : route.dropoff.address }}</span>
              </div>
              <div class="route-meta">
                <span class="vehicle-type">{{ route.vehicleType }}</span>
                <span class="badge" *ngIf="route.babyTransport">Baby Seat</span>
                <span class="badge" *ngIf="route.petTransport">Pet Friendly</span>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="favoriteRoutes.length === 0">
          <p>No favorite routes yet</p>
          <p class="muted">Complete a ride and add it to favorites from your ride history</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal-overlay" *ngIf="showRatingModal" (click)="skipRating()">
    <div class="modal-content rating-modal" (click)="$event.stopPropagation()">
      <h2 class="modal-title">Rate Your Ride</h2>
      <p class="modal-subtitle">How was your experience?</p>

      <div class="rating-section">
        <div class="rating-group">
          <label class="rating-label">Vehicle Rating</label>
          <div class="star-rating">
            <button
              *ngFor="let star of [1, 2, 3, 4, 5]"
              type="button"
              class="star-btn"
              [class.active]="star <= vehicleRating"
              (click)="setVehicleRating(star)"
            >
              â˜…
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label class="rating-label">Driver Rating</label>
          <div class="star-rating">
            <button
              *ngFor="let star of [1, 2, 3, 4, 5]"
              type="button"
              class="star-btn"
              [class.active]="star <= driverRating"
              (click)="setDriverRating(star)"
            >
              â˜…
            </button>
          </div>
        </div>

        <div class="rating-group">
          <label class="rating-label">Comments (Optional)</label>
          <textarea
            class="input rating-textarea"
            [(ngModel)]="ratingComment"
            placeholder="Share your feedback..."
            rows="3"
            maxlength="500"
          ></textarea>
        </div>
      </div>

      <p class="error-message" *ngIf="error">{{ error }}</p>
      <p class="success-message" *ngIf="ratingSuccess">{{ ratingSuccess }}</p>

      <div class="modal-actions">
        <button
          class="secondary"
          type="button"
          (click)="skipRating()"
          [disabled]="ratingSubmitting"
        >
          Skip
        </button>
        <button
          class="primary"
          type="button"
          (click)="submitRating()"
          [disabled]="ratingSubmitting || vehicleRating === 0 || driverRating === 0"
        >
          {{ ratingSubmitting ? 'Submitting...' : 'Submit Rating' }}
        </button>
      </div>

      <p class="modal-note">You have 3 days to rate this ride</p>
    </div>
  </div>
</main>
